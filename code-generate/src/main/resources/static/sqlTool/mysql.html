<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MySQL执行工具</title>
    <script src="../static/common.js?v=1"></script>
    <script src="../static/vue.min.js"></script>
    <script src="../static/axios.min.js"></script>
    <script src="../static/elemeIndex.js"></script>
    <script src="../static/sql-formatter.min.js"></script>
    <link rel="stylesheet" href="../static/elemeIndex.css">
    <style>
        .el-select-dropdown__wrap {
            max-height: 500px;
        }

        .el-table_1_column_1 {
            font-weight: bold;
        }

        .tableHeader {
            font-size: 20px;
        }
    </style>
</head>
<body>

<div id="divApp">
    <el-form :model="searchCond" ref="searchForm" :inline="true" class="demo-form-inline"
             style="text-align: left">
        <el-form-item label="数据库连接信息" style="font-weight: bold;">
            <el-select v-model="selectDbName" filterable placeholder="请选择环境" @change="dbSelected">
                <el-option
                        v-for="item in sqlConns"
                        :key="item.configName"
                        :label="item.configName"
                        :value="item.configName">
                </el-option>
            </el-select>
            <el-form-item label="IP">
                <input type="text" v-model="searchCond.dbTestIp" style="width:240px" :readonly="!isCustom"/>
            </el-form-item>
            <el-form-item label="用户名">
                <input type="text" v-model="searchCond.dbTestUser" style="width:60px" :readonly="!isCustom"/>
            </el-form-item>
            <el-form-item label="密码">
                <input type="password" v-model="searchCond.dbTestPwd" style="width:60px" :readonly="!isCustom"/>
            </el-form-item>
            <el-form-item label="超时-秒">
                <input type="text" v-model.trim="searchCond.dbTimeout" style="width:30px"/>
            </el-form-item>
            <el-button type="primary" icon="el-icon-refresh" circle @click="loadDbs"></el-button>
            <el-form-item label="刷新数据库列表">
                <el-select v-model="searchCond.dbTestName" filterable placeholder="请选择数据库" @change="dbChange"
                           allow-create>
                    <el-option
                            v-for="item in dbsTest"
                            :key="item"
                            :label="item"
                            :value="item">
                    </el-option>
                </el-select>
            </el-form-item>
        </el-form-item>
        <table>
            <tr>
                <td style="width: 1010px;">
                    <el-checkbox v-model="showAsTextBox">文本框展示结果</el-checkbox>
                    <el-button size="small" type="primary" icon="el-icon-search" @click="executeSql">执行SQL</el-button>
                    <span>不支持更新语句，不支持多条语句。另：SQL会默认添加LIMIT 200</span>
                    <p></p>
                    <el-input type="textarea" :rows="20" v-model="searchCond.sql" placeholder="请输入SQL"
                              style="width:1000px"/>
                </td>
                <td v-show="tableList.length">
                    <div style="font-weight: bold;">
                        数据库表清单-{{tableList.length}}个
                    </div>
                    <div style="height: 500px; width: 250px; overflow: scroll;font-size: 12px;">
                        <ul>
                            <li v-for="(item,idx) in tableList">
                                <a :title="item"
                                   href="javascript:void(0)" @click="getSqlByTable(item)">
                                    {{item}}
                                </a>
                            </li>
                        </ul>
                    </div>
                </td>
                <td>
                    <el-tabs v-model="activeName" type="card" @tab-click="handleTabClick">
                        <el-tab-pane :label="'历史SQL-'+usingSqls.length+'个'" name="historySql">
                            <div>
                                <el-button size="mini" round icon="el-icon-download" @click="exportSql(1)">导出
                                </el-button>
                                <el-button size="mini" round icon="el-icon-delete" @click="removeSql(-1, 1)">清空
                                </el-button>
                            </div>
                            <div style="height: 500px; width: 400px; overflow-y: scroll;">
                                <ul>
                                    <li v-for="(item, idx) in usingSqls" style="font-size: 12px;">
                                        <el-button size="mini" circle icon="el-icon-delete"
                                                   @click="removeSql(idx, 1)"></el-button>
                                        <span>
                                    {{idx + 1}}:【{{item.cnt}}条/{{item.ms}}ms/{{item.dbName}}】<br>
                                    <a href="javascript:void(0)" @click="setSqlAndLinkInfo(idx, 1)">{{item.sql}}</a>
                                </span>
                                    </li>
                                </ul>
                            </div>
                        </el-tab-pane>
                        <el-tab-pane :label="'已存SQL-'+savedSqls.length+'个'" name="savedSql">
                            <div>
                                <el-button size="mini" round icon="el-icon-download" @click="exportSql(2)">导出
                                </el-button>
                                <el-button size="mini" round icon="el-icon-delete" @click="removeSql(-1, 2)">清空
                                </el-button>
                            </div>
                            <div style="height: 500px; width: 400px; overflow-y: scroll;">
                                <ul>
                                    <li v-for="(item, idx) in savedSqls" style="font-size: 12px;">
                                        <el-button size="mini" circle icon="el-icon-delete"
                                                   @click="removeSql(idx, 2)"></el-button>
                                        <span>
                                    {{idx + 1}}:<a href="javascript:void(0)" @click="setSqlAndLinkInfo(idx, 2)"
                                                   :title="item.sql">【{{item.title}}/{{item.dbName}}】</a>
                                </span>
                                    </li>
                                </ul>
                            </div>
                        </el-tab-pane>
                    </el-tabs>
                </td>
            </tr>
        </table>
        <br>
        <el-form-item>
            <el-checkbox v-model="showAsTextBox">文本框展示结果</el-checkbox>
            <el-button type="primary" icon="el-icon-search" @click="executeSql">执行SQL</el-button>
            <el-button icon="el-icon-save" @click="saveMySql">保存SQL</el-button>
            <el-button @click="formatSql">格式化SQL</el-button>
            <el-button :disabled="!resultData.length" icon="el-icon-download" @click="exportResult">导出CSV</el-button>
            <el-button icon="el-icon-refresh" @click="location.reload()">页面刷新</el-button>
        </el-form-item>
        <div>
            <span style="padding-left:20px;">耗时: {{costTime}}ms, 行数: {{resultData.length}}</span>
        </div>
    </el-form>
    <br>

    <el-table v-loading="loading"
              element-loading-text="拼命加载中"
              element-loading-spinner="el-icon-loading"
              element-loading-background="rgba(0, 0, 0, 0.8)"
              border
              max-height="620"
              :data="resultData"
              :header-row-class-name="'tableHeader'"
              style="margin-bottom: 10px;">
        <el-table-column :label="key"
                         sortable
                         :sort-by="key"
                         v-for="(value, key, index) in resultData[0]">
            <template slot-scope="scope">
                <input v-show="showAsTextBox" type="text" :value="scope.row[key]" style="width:100%"
                       @click="showFieldValue(scope.row, key)">
                <span v-show="!showAsTextBox">{{scope.row[key]}}</span>
            </template>
        </el-table-column>
    </el-table>

    <el-dialog :title="'表定义: ' + selectedTable" :visible.sync="generateSqlShow" width="80%" top="5vh">
        <div style="display: flex; gap: 20px;">
            <!-- 左侧：表结构显示区域 -->
            <div style="flex: 1;">
                <div style="margin-bottom: 10px; font-weight: bold; color: #409EFF;">
                    <i class="el-icon-document"></i> 表结构定义
                </div>
                <el-input
                        type="textarea"
                        :rows="18"
                        v-model="generateSql"
                        readonly
                        style="font-family: 'Courier New', monospace; font-size: 12px;">
                </el-input>
            </div>
            
            <!-- 右侧：操作面板 -->
            <div style="width: 350px; border-left: 1px solid #eee; padding-left: 20px;">
                <div style="margin-bottom: 15px; font-weight: bold; color: #409EFF;">
                    <i class="el-icon-setting"></i> SQL生成操作
                </div>
                
                <!-- SQL模板生成 -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <div style="margin-bottom: 10px; font-weight: bold; font-size: 14px; color: #333;">
                        <i class="el-icon-document-copy"></i> SQL模板
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <el-button type="primary" icon="el-icon-search" @click="generateSelectSql" style="width: 100%;">
                            生成SELECT并执行查询
                        </el-button>
                        <el-button type="warning" icon="el-icon-edit" @click="generateUpdateSql" style="width: 100%;">
                            生成 UPDATE 模板
                        </el-button>
                        <el-button type="info" icon="el-icon-plus" @click="generateInsertSql" style="width: 100%;">
                            生成 INSERT 模板
                        </el-button>
                    </div>
                </div>
                
                <!-- 数据导出 -->
                <div style="padding: 15px; background: #f0f9ff; border-radius: 6px; border: 1px solid #b3d8ff;">
                    <div style="margin-bottom: 15px; font-weight: bold; font-size: 14px; color: #333;">
                        <i class="el-icon-download"></i> 数据导出设置
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #666;">导出行数限制</label>
                        <el-input-number 
                            v-model="exportRowLimit" 
                            :min="1" 
                            :max="100000" 
                            controls-position="right"
                            style="width: 100%;"
                            placeholder="1000">
                        </el-input-number>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #666;">排除字段</label>
                        <el-input 
                            v-model.trim="excludeFields" 
                            placeholder="id, create_date, update_date"
                            style="width: 100%;">
                            <template slot="suffix">
                                <el-tooltip content="多个字段用逗号分隔，不区分大小写" placement="top">
                                    <i class="el-icon-question" style="color: #999;"></i>
                                </el-tooltip>
                            </template>
                        </el-input>
                        <div style="font-size: 12px; color: #999; margin-top: 3px;">
                            多个字段用逗号分隔
                        </div>
                    </div>
                    
                    <el-button type="success" icon="el-icon-download" @click="exportTableDataAsSql" style="width: 100%; height: 40px; font-weight: bold;">
                        导出数据SQL
                    </el-button>
                </div>
            </div>
        </div>
    </el-dialog>

    <el-dialog :title="'字段值详情:' + selectedTable + '.' + selectedField + '（按ESC关窗）'"
               :visible.sync="fieldValueShow">
        <div>
            <el-input
                    type="textarea"
                    :rows="20"
                    v-model="selectedFieldValue">
            </el-input>
        </div>
        <template>
            <el-button type="primary" @click="formatJson">JSON格式化</el-button>
            <span v-html="jsonFormatError"></span>
        </template>
    </el-dialog>

    <el-dialog title="保存SQL" :visible.sync="savedSqlShow">
        <div>
            保存说明：<input type="text" style="width: 200px" v-model.trim="savedTxt">
            <el-button type="primary" @click="saveMySqlDo">存入LocalStorage</el-button>
        </div>
    </el-dialog>
</div>
<script>
    const vueApp = new Vue({
        el: '#divApp',
        data: {
            activeName: 'historySql',
            loading: false,
            historySqlMaxLength: 30, // 历史SQL最多存储多少条

            selectDbName: '', // 默认选中的数据库实例
            sqlConns: [
                // {  // 要求数据结构如下
                //     configName: '生产-1',
                //     dbTestIp: '10.0.0.1',
                //     dbTestUser: 'readonly',
                //     dbTestPwd: '123456',
                //     dbTestName: '',
                // }
            ],
            searchCond: {
                configName: '',
                dbTestIp: '',
                dbTestUser: '',
                dbTestPwd: '',
                dbTestName: '',
                dbTimeout: '5',
                sql: '',
            },

            dbsTest: {},
            defaultName: '',
            tableList: [],
            tableCancelToken: null, // 表列表请求取消令牌

            costTime: 0,
            resultData: [],

            usingSqls: [],
            usingKey: 'usingSqls',
            savedSqls: [],
            savedKey: 'savedSqls',
            savedSqlShow: false,
            savedTxt: '',

            generateSqlShow: false,
            selectedTable: '',
            generateSql: '',
            exportRowLimit: 1000, // 默认导出行数限制
            excludeFields: 'id, create_date, update_date', // 导出时排除的字段列表
            dbCancelToken: null, // 数据库请求取消令牌

            showAsTextBox: true,
            fieldValueShow: false,
            selectedField: '',
            selectedFieldValue: '',
            jsonFormatError: '',
        },
        created: function () {
            this.loadConnections().then(() => {
                this.defaultName = getQueryString('name');
                this.usingSqls = this.loadSqls(this.usingKey);
                this.savedSqls = this.loadSqls(this.savedKey);
                this.dbSelected();
            });
        },
        computed: {
            isCustom: function () {
                return this.selectDbName === '' || this.selectDbName === '自定义';
            }
        },
        methods: {
            handleTabClick: function (tab, event) {
            },
            loadConnections: function () {
                let url = $$BASE_URL + 'linkinfo/list?type=mysql';
                return axios.get(url).then(response => {
                    if (!response.data || !response.data.length) {
                        return alert('出错:' + response.data.errMsg);
                    }
                    for (let i = 0, j = response.data.length; i < j; i++) {
                        let item = response.data[i];
                        this.sqlConns.push({
                            configName: item.name,
                            dbTestIp: item.address,
                            dbTestUser: item.account,
                            dbTestPwd: '123456',
                            dbTestName: '',
                        });
                    }
                    this.sqlConns.push({
                        configName: '自定义',
                        dbTestIp: '',
                        dbTestUser: '',
                        dbTestPwd: '',
                        dbTestName: '',
                    });
                }).catch(error => {
                    this.ajaxError(error);
                });
            },
            dbSelected: function () {
                if (!this.selectDbName && this.sqlConns.length) {
                    this.selectDbName = this.sqlConns[0].configName;
                }
                
                // 立即清空数据库和表列表，避免显示之前连接的数据
                this.dbsTest = {};
                this.tableList = [];
                
                for (let i = 0, j = this.sqlConns.length; i < j; i++) {
                    if (this.sqlConns[i].configName === this.selectDbName) {
                        this.copyAtts(this.sqlConns[i]);
                        if (this.searchCond.configName === '自定义')
                            return;
                        this.loadDbs();
                        break;
                    }
                }
            },
            copyAtts: function (sqlConn) {
                // 修复sql无法设置或只读的bug
                for (const prop in sqlConn) {
                    Vue.set(this.searchCond, prop, sqlConn[prop]);
                }
            },
            dbChange: function () {
                this.loadTables();
            },
            getArrSql: function (flg) {
                return flg === 1 ? this.usingSqls : this.savedSqls;
            },
            getArrSqlKey: function (flg) {
                return flg === 1 ? this.usingKey : this.savedKey;
            },
            setArrSql: function (flg, arr) {
                if (flg === 1)
                    this.usingSqls = arr;
                else
                    this.savedSqls = arr;
            },
            setSqlAndLinkInfo: function (idx, flg) {
                let arrSql = this.getArrSql(flg);
                let item = arrSql[idx];
                this.realSetSql(item.sql);

                if (item.insName !== this.selectDbName ||
                    item.dbName !== this.searchCond.dbTestName) {
                    this.selectDbName = item.insName;
                    this.defaultName = item.dbName;

                    this.dbSelected();
                }
            },
            realSetSql: function (sql) {
                Vue.set(this.searchCond, 'sql', sql);
                //console.log(sql)
            },
            exportSql: function (flg) {
                let arrSql = this.getArrSql(flg);
                if (!arrSql || !arrSql.length) {
                    return alert('没有历史SQL可导出');
                }
                let dataContent = '';
                for (let i = 0, j = arrSql.length; i < j; i++) {
                    let row = arrSql[i];
                    if (i > 0) {
                        dataContent += '\r\n';
                    }
                    let cell = (row.sql + '').replace(/"/g, '""'); // csv里的双引号转义为2个
                    dataContent += '="' + cell + '",';  // 加= 是避免数字变成科学计数
                }
                window.downloadDataToCsv('历史SQL\r\n' + dataContent);
            },
            removeSql: function (idx, flg) {
                if (idx === -1) {
                    this.setArrSql(flg, []);
                } else {
                    let arrSql = this.getArrSql(flg);
                    arrSql.splice(idx, 1);
                }
                this.saveToStorage(flg);
            },
            loadSqls: function (key) {
                let obj = localStorage.getItem(key);
                if (obj == null)
                    return [];
                return JSON.parse(obj);
            },
            saveUsingSqls: function (title, sql, rowCnt, costMs, instanceName, dbName, flg) {
                this.realSetSql(sql);
                let item = {
                    title: title,
                    sql: sql,
                    cnt: rowCnt,
                    ms: costMs,
                    insName: instanceName,
                    dbName: dbName,
                };

                let arrSql = this.getArrSql(flg);
                this.addAndDistinct(item, arrSql);
                if (flg === 1 && arrSql.length > this.historySqlMaxLength) {
                    arrSql.length = this.historySqlMaxLength;
                }
                this.saveToStorage(flg);
            },
            saveToStorage: function (flg) {
                let key = this.getArrSqlKey(flg);
                let arrSql = this.getArrSql(flg);
                localStorage.setItem(key, JSON.stringify(arrSql));
            },
            addAndDistinct: function (item, arr) {
                for (let i = 0, j = arr.length; i < j; i++) {
                    if (arr[i].sql == item.sql)
                        return;
                }
                arr.splice(0, 0, item);// 插入第1位
            },
            combineDbPara: function () {
                if (!this.searchCond.dbTestIp || !this.searchCond.dbTestUser || !this.searchCond.dbTestPwd) {
                    alert('请输入数据库IP/用户/密码');
                    throw new Error('请输入数据库IP/用户/密码');
                }
                return 'ip=' + this.searchCond.dbTestIp +
                    '&user=' + encodeURIComponent(this.searchCond.dbTestUser) +
                    '&pwd=' + encodeURIComponent(this.searchCond.dbTestPwd) +
                    '&name=' + encodeURIComponent(this.searchCond.configName);
            },
            loadDbs: function () {
                this.dbsTest = {};
                this.tableList = []; // 清空表列表
                
                // 取消前一次数据库请求
                if (this.dbCancelToken) {
                    this.dbCancelToken.cancel('新的数据库请求已发起');
                }
                
                // 创建新的取消令牌
                this.dbCancelToken = axios.CancelToken.source();
                let currentIp = this.searchCond.dbTestIp;
                let url = $$BASE_URL + 'mysql/databases?' + this.combineDbPara();
                
                return axios.get(url, {
                    cancelToken: this.dbCancelToken.token
                }).then(response => {
                    if (response.data.code && response.data.code === 500) {
                        return alert(currentIp + '出错:\n' + response.data.errMsg);
                    }
                    this.dbsTest = response.data;
                    this.setByDefault('dbTestName', this.dbsTest);

                    this.loadTables();
                }).catch(error => {
                    if (!axios.isCancel(error)) {
                        this.ajaxError(error);
                    }
                }).finally(() => {
                    this.dbCancelToken = null;
                });
            },
            loadTables: function () {
                if (!this.searchCond.dbTestName)
                    return;
                
                // 取消前一次表列表请求
                if (this.tableCancelToken) {
                    this.tableCancelToken.cancel('新的表列表请求已发起');
                }
                
                // 创建新的取消令牌
                this.tableCancelToken = axios.CancelToken.source();
                let url = $$BASE_URL + 'mysql/tableNames?' + this.combineDbPara() + '&db=' + this.searchCond.dbTestName;
                
                return axios.get(url, {
                    cancelToken: this.tableCancelToken.token
                }).then(response => {
                    this.tableList = response.data;
                }).catch(error => {
                    if (!axios.isCancel(error)) {
                        this.ajaxError(error);
                    }
                }).finally(() => {
                    this.tableCancelToken = null;
                });
            },
            getSqlByTable: function (tbName) {
                if (!this.searchCond.dbTestName || !tbName)
                    return;
                this.selectedTable = tbName;
                let url = $$BASE_URL + 'mysql/tables/ddl?' +
                    this.combineDbPara() +
                    '&db=' + this.searchCond.dbTestName +
                    '&tableName=' + encodeURIComponent(tbName);
                return axios.get(url).then(response => {
                    this.generateSql = response.data;
                    this.generateSqlShow = true;
                }).catch(error => {
                    this.ajaxError(error);
                });
                /*
                this.searchCond.sql = 'SELECT * FROM `' + this.searchCond.dbTestName +
                    '`.`' + tbName +
                    '` \nWHERE 1=1\nORDER BY 1 DESC';
                 */
            },
            generateSelectSql: function () {
                let fieldList = this.generateFields();
                if (!fieldList || fieldList.length <= 0) {
                    return '未找到字段';
                }
                let sql = 'SELECT ';
                for (let i = 0, j = fieldList.length; i < j; i++) {
                    if (i > 0)
                        sql += ',\n       ';
                    sql += 'a.`' + fieldList[i] + '`';
                }
                sql += '\n  FROM `' + this.searchCond.dbTestName + '`.`'
                    + this.selectedTable + '` a\n WHERE 1=1\n ORDER BY '
                    + this.generatePrimaryKey()
                    + ' DESC LIMIT 200;';
                this.realSetSql(sql);
                this.generateSqlShow = false;

                this.executeSql();
            },
            saveMySql: function () {
                this.savedSqlShow = true;
            },
            saveMySqlDo: function () {
                if (this.savedTxt.length === 0) {
                    return alert('请输入SQL文本');
                }
                this.saveUsingSqls(
                    this.savedTxt,
                    this.searchCond.sql,
                    0,
                    0,
                    this.selectDbName,
                    this.searchCond.dbTestName,
                    2);
                this.savedSqlShow = false;
                this.activeName = 'savedSql';
            },
            generateUpdateSql: function () {
                let fieldList = this.generateFields();
                if (!fieldList || fieldList.length <= 0) {
                    return '未找到字段';
                }
                let sql = 'UPDATE `' + this.searchCond.dbTestName + '`.`'
                    + this.selectedTable + '`\n   SET ';
                for (let i = 0, j = fieldList.length; i < j; i++) {
                    if (i > 0)
                        sql += ',\n       ';
                    sql += '`' + fieldList[i] + '`=\'{' + fieldList[i] + '}\'';
                }
                sql += '\n WHERE ' + this.generatePrimaryKey() + '={xxx};';
                this.realSetSql(sql);
                this.generateSqlShow = false;
            },
            generateInsertSql: function () {
                let fieldList = this.generateFields();
                if (!fieldList || fieldList.length <= 0) {
                    return '未找到字段';
                }
                let sql = 'INSERT INTO `' + this.searchCond.dbTestName + '`.`'
                    + this.selectedTable + '`\n(\n       ';
                for (let i = 0, j = fieldList.length; i < j; i++) {
                    if (i > 0)
                        sql += ',\n       ';
                    sql += '`' + fieldList[i] + '`';
                }
                sql += '\n)VALUES(\n       ';
                for (let i = 0, j = fieldList.length; i < j; i++) {
                    if (i > 0)
                        sql += ',\n       ';
                    sql += '\'{' + fieldList[i] + '}\'';
                }
                sql += '\n);';
                this.realSetSql(sql);
                this.generateSqlShow = false;
            },
            generateFields: function () {
                let fieldList = [];

                let regex = /[\r\n]+\s+`([^`]+)`/g;  // 一定要有最后的g
                let match = '';
                while (match = regex.exec(this.generateSql)) {
                    fieldList.push(match[1]);
                }
                return fieldList;
            },
            generatePrimaryKey: function () {
                let regex = /PRIMARY\s+KEY\s+\(([^)]+)\)/g;
                if (regex.test(this.generateSql)) {
                    return RegExp.$1;
                }
                return '1';
            },

            showFieldValue: function (row, key) {
                this.jsonFormatError = '';
                this.fieldValueShow = true;
                this.selectedField = key;
                this.selectedFieldValue = row[key];
            },
            formatJson: function (throwErr) {
                this.jsonFormatError = '';
                try {
                    let result = JSON.parse(this.selectedFieldValue);
                    if (typeof (result) === 'string') {
                        result = JSON.parse(result);
                    }
                    this.selectedFieldValue = JSON.stringify(result, null, 4);
                } catch (e) {
                    if (throwErr === true) {
                        this.jsonFormatError = '错误:' + e;
                        return;
                    }
                    this.selectedFieldValue = '"' + this.selectedFieldValue + '"';
                    this.formatJson(true);
                }
            },

            setByDefault: function (prop, arr) {
                if (arr.length <= 0) {
                    Vue.set(this.searchCond, prop, '');
                    return;
                }
                if (this.defaultName) {
                    for (let i = 0, j = arr.length; i < j; i++) {
                        if (arr[i].indexOf(this.defaultName) >= 0) {
                            Vue.set(this.searchCond, prop, arr[i]);
                            return;
                        }
                    }
                }
                Vue.set(this.searchCond, prop, arr[0]);
            },
            formatSql: function () {
                let sql = sqlFormatter.format(this.searchCond.sql,
                    {language: 'sql', indent: '  '});
                this.realSetSql(sql);
            },
            executeSql: function () {
                if (!this.searchCond.dbTestName) {
                    return alert('数据库必选');
                }
                this.attData = [];

                let url = $$BASE_URL + 'mysql/executeSql?';
                let beginTime = new Date();
                this.resultData = [];
                let body = {
                    'sql': this.searchCond.sql,
                    'time': this.searchCond.time,
                    'ip': this.searchCond.dbTestIp,
                    'user': this.searchCond.dbTestUser,
                    'pwd': this.searchCond.dbTestPwd,
                    'db': this.searchCond.dbTestName,
                    'name': this.searchCond.configName,
                    'dbTimeout': this.searchCond.dbTimeout,
                };
                if (this.loading) {
                    return alert('执行中，请稍候');
                }
                this.loading = true;
                return axios.post(url, body).then(response => {
                    this.costTime = Math.floor((new Date()) - beginTime);
                    this.loading = false;
                    if (response.data.code !== 200) {
                        return alert(response.data.code + ':' + response.data.errMsg);
                    }
                    this.resultData = response.data.result;
                    this.saveUsingSqls('',
                        response.data.errMsg,  // 后端实际使用的sql
                        this.resultData.length,
                        this.costTime,
                        this.selectDbName,
                        this.searchCond.dbTestName,
                        1);
                }).catch(error => {
                    this.loading = false;
                    this.ajaxError(error);
                });
            },
            exportResult: function () {
                window.exportDataToCsv(this.resultData);
            },

            // 把指定的表，导出为INSERT INTO语句
            exportTableDataAsSql: function () {
                if (!this.searchCond.dbTestName || !this.selectedTable) {
                    return alert('请先选择数据库和表');
                }

                // 验证导出行数限制
                let limit = this.exportRowLimit || 1000;
                if (limit <= 0 || limit > 100000) {
                    return alert('导出行数必须在1-100000之间');
                }

                // 构建SELECT语句，排除指定字段
                let selectFields = '*';
                if (this.excludeFields) {
                    // 如果有排除字段，需要先获取表结构来构建字段列表
                    // 这里先使用 * 查询，在后续处理中排除字段
                }
                let sql = 'SELECT * FROM `' + this.searchCond.dbTestName + '`.`' + this.selectedTable + '` LIMIT ' + limit;
                let url = $$BASE_URL + 'mysql/executeSql?';
                let body = {
                    'sql': sql,
                    'ip': this.searchCond.dbTestIp,
                    'user': this.searchCond.dbTestUser,
                    'pwd': this.searchCond.dbTestPwd,
                    'db': this.searchCond.dbTestName,
                    'name': this.searchCond.configName,
                    'dbTimeout': this.searchCond.dbTimeout,
                };

                if (this.loading) {
                    return alert('正在执行中，请稍候');
                }

                this.loading = true;
                axios.post(url, body).then(response => {
                    this.loading = false;
                    if (response.data.code !== 200) {
                        return alert(response.data.code + ':' + response.data.errMsg);
                    }

                    // 生成INSERT语句
                    let insertSqls = this.generateInsertSqlsFromData(response.data.result);
                    if (insertSqls.length === 0) {
                        return alert('表中没有数据可导出');
                    }

                    // 下载SQL文件
                    this.downloadSqlFile(insertSqls, response.data.result.length);
                    this.generateSqlShow = false;
                }).catch(error => {
                    this.loading = false;
                    this.ajaxError(error);
                });
            },

            generateInsertSqlsFromData: function (data) {
                if (!data || data.length === 0) {
                    return [];
                }

                // 获取所有字段名
                let allFieldNames = Object.keys(data[0]);
                
                // 处理排除字段列表
                let excludeFieldsArray = [];
                if (this.excludeFields) {
                    excludeFieldsArray = this.excludeFields.split(',').map(field => field.trim().toLowerCase()).filter(field => field);
                }
                
                // 过滤掉排除的字段（不区分大小写）
                let fieldNames = allFieldNames.filter(fieldName => {
                    return !excludeFieldsArray.includes(fieldName.toLowerCase());
                });

                let allValuesRows = [];

                // 为每一行数据生成VALUES部分
                for (let i = 0; i < data.length; i++) {
                    let row = data[i];
                    let values = [];

                    for (let j = 0; j < fieldNames.length; j++) {
                        let fieldName = fieldNames[j];
                        let value = row[fieldName];

                        if (value === null || value === undefined) {
                            values.push('NULL');
                        } else if (typeof value === 'string') {
                            // 转义单引号
                            value = value.replace(/'/g, "''");
                            values.push("'" + value + "'");
                        } else if (typeof value === 'number') {
                            values.push(value.toString());
                        } else {
                            // 其他类型转为字符串处理
                            value = String(value).replace(/'/g, "''");
                            values.push("'" + value + "'");
                        }
                    }

                    allValuesRows.push('(' + values.join(', ') + ')');
                }

                // 生成单条INSERT语句
                let fieldsPart = fieldNames.map(name => '`' + name + '`').join(', ');
                let insertSql = 'INSERT INTO `' + this.searchCond.dbTestName + '`.`' + this.selectedTable + '` (' + fieldsPart + ') VALUES\n  ' + allValuesRows.join(',\n  ') + ';';
                
                return [insertSql]; // 返回包含单条SQL的数组
            },

            downloadSqlFile: function (insertSqls, dataRowCount) {
                let sqlContent = '-- 表 ' + this.selectedTable + ' 的数据导出\n';
                sqlContent += '-- 导出时间: ' + new Date().toLocaleString() + '\n';
                sqlContent += '-- 数据行数: ' + dataRowCount + '\n';
                if (this.excludeFields) {
                    sqlContent += '-- 排除字段: ' + this.excludeFields + '\n';
                }
                sqlContent += '\n' + insertSqls.join('\n') + '\n';

                // 创建下载链接
                let blob = new Blob([sqlContent], {type: 'text/plain;charset=utf-8'});
                let url = window.URL.createObjectURL(blob);
                let a = document.createElement('a');
                a.href = url;
                a.download = this.selectedTable + '_data_export.sql';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                let limitInfo = dataRowCount >= this.exportRowLimit ? '（已达到导出上限）' : '';
                alert('SQL文件已生成并下载，1条INSERT语句包含 ' + dataRowCount + ' 行数据' + limitInfo);
            },

            ajaxError: function (error) {
                window.ajaxError(error, vueApp);
            },
        },
    });
</script>
</body>
</html>